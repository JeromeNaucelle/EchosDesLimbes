{% extends CMS_TEMPLATE %}
{% load django_bootstrap5 breadcrumbs %}

{% block breadcrumb %}
    {% block breadcrumbs %}
    
    {% root_breadcrumb_url 'Mes fiches' 'larp:character_list' %}

    {% breadcrumb pnj_infos.larp.name %}
    {% breadcrumb_url 'Fiche PNJ' 'larp:view_pnj' pnj_infos.pk %}
    {% endblock %}
{% endblock %}

{% block cms_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="pb-4">{{ title }}</h2>

            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Informations de contact Orga</h4>
                </div>
                <div class="card-body" style="background-color: var(--sand-bg-subtle)">
                    {% if inscription.access_type == 'PNJF'  %}
                    {{ inscription.faction.orga_contact|linebreaks }}
                    {% else  %}
                    {{ larp.pnjv_orga_contact|linebreaks }}
                    {% endif  %}
                </div>
            </div>
            
            <!-- PNJ Basic Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Informations générales</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Joueur:</strong> {{ user.first_name }} {{ user.last_name }} ({{ user.username }})</p>
                            <p><strong>GN:</strong> {{ larp.name }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Préférence horaire:</strong> 
                                {% if pnj_infos.prefered_time %}
                                    {{ pnj_infos.get_prefered_time_display }}
                                {% else %}
                                    Non spécifié
                                {% endif %}
                            </p>
                            <p><strong>Action de nuit:</strong> 
                                {% if pnj_infos.nigth_action is None %}
                                    Non spécifié
                                {% elif pnj_infos.nigth_action %}
                                    Oui
                                {% else %}
                                    Non
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Preferences -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Préférences de jeu</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Logistique vs Rôles:</strong> 
                                {% if pnj_infos.logistic_or_role is not None %}
                                    {{ pnj_infos.get_logistic_or_role_display }}
                                {% else %}
                                    Non spécifié
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Niveau d'importance:</strong> 
                                {% if pnj_infos.importance is not None %}
                                    {{ pnj_infos.get_importance_display }}
                                {% else %}
                                    Non spécifié
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Talents -->
            {% if pnj_infos.talent %}
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Talents particuliers</h4>
                </div>
                <div class="card-body">
                    <div class="border p-3" style="background-color: var(--grey-bg);">
                        {{ pnj_infos.talent|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Organizer Information -->
            {% if pnj_infos.info_orga %}
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Informations pour l'organisation</h4>
                </div>
                <div class="card-body">
                    <div class="border p-3" style="background-color: var(--grey-bg);">
                        {{ pnj_infos.info_orga|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-4">
                {% if not pnj_infos.completed or is_orga %}
                <a href="{% url 'larp:pnj_form' pnj_infos.pk %}" class="btn btn-primary">
                    <i class="fa-solid fa-edit"></i> Modifier les informations
                </a>
                {% endif %}
                {% if not is_orga and not pnj_infos.completed %}
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#statusConfirmationModal">
                    Demander la validation Orga
                    </button>
                {% endif %}
                <a href="{% url 'larp:view_pnj_pdf' pnj_infos.pk %}" class="btn btn-success">
                    <i class="fa-solid fa-file-pdf"></i> Exporter en PDF
                </a>
                {% if request.user.pk == pnj_infos.user.pk %}
                <a href="{% url 'larp:character_list' %}" class="btn btn-outline-secondary">
                {% else %}
                <a href="{% url 'larp:orga_gn' pnj_infos.larp.pk %}" class="btn btn-sand">
                {% endif %}
                    <i class="fa-solid fa-arrow-left"></i> Retour à la liste
                </a>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="statusConfirmationModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Confirmation</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Attention, en faisant ça vous ne pourrez plus modifier votre fiche sans qu'un orga vous y autorise de nouveau. Avez-vous bien rempli tout ce que vous souhaitiez ?
      </div>
      <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <form method="post" action="{% url 'larp:change_pnj_status' pnj_infos.pk %}">
            <input type="hidden" name="completed" value="1"/>
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Verrouiller</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
