{% extends CMS_TEMPLATE %}
{% load django_bootstrap5  partials django_htmx breadcrumbs %}

{% block breadcrumb %}
    {% block breadcrumbs %}
    
    {% root_breadcrumb_url 'Mes fiches' 'larp:character_list' %}

    {% breadcrumb larp.name %}
    {% breadcrumb 'Fiche Personnage' %}
    {% breadcrumb_url pj_infos.name 'larp:view_pj' pj_infos.pk%}
    {% endblock %}
{% endblock %}

{% block body_attrs %}
hx-headers='{"x-csrftoken": "{{ csrf_token }}"}'
{% endblock %}

{% block page_head %}
{% htmx_script %}
{% endblock %}

{% block cms_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="pb-4">{{ title }}</h2>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-4">
                {% if pj_infos.status == 'UNLOCKED' or is_orga %}
                <a href="{% url 'larp:edit_pj' pj_infos.pk %}" class="btn btn-primary">
                    <i class="fa-solid fa-edit"></i> Modifier le personnage
                </a>
                {% endif %}
                {% if pj_infos.bg_completed == False %}
                <a href="{% url 'larp:complete_bg' pj_infos.pk %}" class="btn btn-secondary">
                    <i class="fa-solid fa-list-check"></i> Compléter le background
                </a>
                {% elif not is_orga and pj_infos.status == 'UNLOCKED' %}
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#statusConfirmationModal">
                    Demander la validation Orga
                    </button>
                {% endif %}
                <a href="{% url 'larp:view_pj_pdf' pj_infos.pk %}" class="btn btn-success">
                    <i class="fa-solid fa-file-pdf"></i> Exporter en PDF
                </a>    
            </div>

            <div class="mb-4">
                {% if pj_infos.bg_completed and is_orga %}
                <form action="{% url 'larp:change_pj_status' pj_infos.pk %}" method="post">
                    {% csrf_token %}
                    {% bootstrap_form status_form %}
                    <div style="text-align: center;">
                        {% bootstrap_button button_type="submit" content="Valider" extra_classes="submit_btn w-75" %}
                    </div>
                </form>
                {% endif %}
            </div>

            <!-- Début de la fiche perso -->
            
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Informations de contact Orga</h4>
                </div>
                <div class="card-body" style="background-color: var(--sand-bg-subtle)">
                    {{ pj_infos.faction.orga_contact|linebreaks }}
                </div>
            </div>

            {% partialdef pj-documents inline %}
            <div class="card mb-4" id="pj-documents">
                <div class="card-header">
                    <h4 class="mb-0">Documents et livrets de jeu</h4>
                </div>
                <div class="card-body" style="background-color: var(--sand-bg-subtle)">

                    
                    <div class="container">
                        {% for document in pj_infos.documents.all %}
                        <div class="row mb-1" style="border-bottom: 1px solid rgb(163, 175, 200);">
                            <div class="col">
                                <a href="{{ document.document_url }}" style="color: black;"> {{ document }} </a>
                            </div>
                            {% if is_orga %}
                            <div class="col">
                                <form hx-delete="{% url 'larp:player_document' pj_infos.pk %}" hx-target="#pj-documents" hx-swap="outerHTML">
                                    {% csrf_token %}
                                    <input type="hidden" value="{{ document.pk }}" name="document_id"/>
                                    <button type="submit" class="btn btn-danger m-1" ><i class="fa-solid fa-square-xmark"></i> Supprimer</button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                        {% empty %}                        
                        <div class="row">
                            Aucun pour l'instant
                        </div>
                        {% endfor %}
                    </div>
                        
                    {% if is_orga %}
                    <h3 class="mt-3">Ajouter un document</h3>
                    <form hx-post="{% url 'larp:player_document' pj_infos.pk %}" hx-target="#pj-documents" hx-swap="outerHTML">
                        {% csrf_token %}
                        {% bootstrap_form document_form %}
                        <div style="text-align: center;">
                            <button type="submit" class="btn btn-primary w-75" >Valider</button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endpartialdef %}

            <!-- Character Basic Information -->
            <div class="row">
                <div class="col-6 col-md-6 col-sm-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4 class="mb-0">Informations générales</h4>
                        </div>
                        <div class="card-body">
                            <p><strong>Nom du personnage:</strong> {{ pj_infos.name }}</p>
                            <p><strong>Joueur:</strong> {{ user.first_name }} {{ user.last_name }} ({{ user.username }})</p>
                            <p><strong>GN:</strong> {{ larp.name }}</p>
                            <p><strong>{{ larp.factions_name }}:</strong> {{ faction.name }}</p>
                            <p><strong>Préférence émotionnelle:</strong> {{ pj_infos.get_emotions_display }}</p>
                        </div>
                    </div>
                </div>

                <!-- Skills Information -->
                <div class="col-6 col-md-6 col-sm-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4 class="mb-0">Compétences</h4>
                        </div>
                        <div class="card-body">
                            <p><strong>Compétences actuelles:</strong></p>
                            <div class="border p-3 mb-3" style="background-color: var(--grey-bg);">
                                {{ pj_infos.skills|linebreaks }}
                            </div>
                            
                            {% if pj_infos.last_learned %}
                            <p><strong>Dernière compétence apprise:</strong> {{ pj_infos.last_learned }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>


            <!-- Game Objectives -->
            {% if pj_infos.objectives %}
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Objectifs de jeu</h4>
                </div>
                <div class="card-body">
                    <div class="border p-3" style="background-color: var(--grey-bg);">
                        {{ pj_infos.objectives|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Background Choices -->
            {% if bg_choices %}
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Choix de background</h4>
                </div>
                <div class="card-body">
                    {% for bg_choice in bg_choices %}
                    <div class="mb-4" id="bg-choice-{{ bg_choice.pk }}">
                        <div class="d-flex justify-content-between">
                            <h5>Étape {{ bg_choice.step }} : </h5>

                            {% if pj_infos.status == 'UNLOCKED' or is_orga %}
                            <button type="button" 
                                class="btn btn-success mb-2"
                                hx-get="{% url 'larp:edit_bg_choice' bg_choice.pk %}"
                                hx-swap="outerHTML"
                                hx-target="#bg-choice-{{ bg_choice.pk }}"
                                > <i class="fa-solid fa-edit"> </i> Modifier</button>
                            {% endif %}
                        </div>
                        <p>{{ bg_choice.bgchoice.bg_step.question }}</p>
                        
                        <div class="border p-3 mb-2" style="background-color: var(--grey-bg);">
                            {% if bg_choice.bgchoice.text %}
                            <em>{{ bg_choice.bgchoice.text }}</em>
                            {% endif %}
                        </div>
                        
                        {% if bg_choice.player_text %}
                        <div class="border p-3" style="background-color: var(--grey-bg);">
                            <strong>Commentaire du joueur:</strong><br>
                            {{ bg_choice.player_text|linebreaks }}
                        </div>
                        {% endif %}
                    </div>
                    {% if not forloop.last %}<hr>{% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Retour à la page précédente -->
            <div>
                {% if request.user.pk == pj_infos.user.pk %}
                <a href="{% url 'larp:character_list' %}" class="btn btn-sand">
                {% else %}
                <a href="{% url 'larp:orga_gn' pj_infos.larp.pk %}" class="btn btn-sand">
                {% endif %}
                    <i class="fa-solid fa-arrow-left"></i> Retour à la liste
                </a>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="statusConfirmationModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Confirmation</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Attention, en faisant ça vous ne pourrez plus modifier votre fiche sans qu'un orga vous y autorise de nouveau. Avez-vous bien rempli tout ce que vous souhaitiez ?
      </div>
      <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <form method="post" action="{% url 'larp:change_pj_status' pj_infos.pk %}">
            <input type="hidden" name="status" value="PLAYER_VALIDATED"/>
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Verrouiller</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
